{{- $curPage := .Page -}}

{{- /* Error level when description not in recommended length: ignore, warning, or error. */ -}}
{{- $errorLevel := (or site.Params.seo.description.length.errorLevel "warning") | lower -}}
{{- $maxDesc := or site.Params.seo.description.length.max 160 }}
{{- $minDesc := or site.Params.seo.description.length.min 110 }}

{{- /* ignore description length for specified pages */ -}}
{{- range site.Params.seo.description.lengthIgnores }}
	{{- if gt (len (findRE . $curPage.TranslationKey)) 0 }}
		{{- $errorLevel = "ignore" }}
	{{- end }}
{{- end }}

{{- /* Do fallback to page summary before fallback to site description */ -}}
{{- $summaryFallback := true -}}
{{- if isset site.Params.seo.description "summaryFallback" }}
	{{- $summaryFallback = site.Params.seo.description.summaryFallback }}
{{- end }}

{{- /* Validate error level. */}}
{{- if not (in (slice "ignore" "warning" "error") $errorLevel) }}
	{{- errorf "The seo descriptionLength is misconfigured. The errorLevel %q is invalid. Please check your site configuration." $errorLevel }}
{{- end }}

{{- $description := "" }}
{{- if .Params.seo.description }}
	{{- $description = .Params.seo.description }}
{{- else if .Description }}
	{{- $description = .Description }}
{{- else if and $summaryFallback $curPage.Summary }}
	{{- $description = $curPage.Summary | plainify }}
{{- else if and $summaryFallback $curPage.Params.summary }}
	{{- $description = $curPage.Params.summary | plainify }}
{{- else if site.Params.seo.description.siteParamsFallback }}
  {{- $description = site.Params.Description }}
{{- end }}
{{- if ne $errorLevel "ignore" }}
	{{- $lengthMessage := "" }}
	{{- $descriptionLength := len $description }}
	{{- if lt $descriptionLength $minDesc }}
		{{- $lengthMessage = printf "Description too short on page '%s'. %d characters is < %d" .Page.TranslationKey $descriptionLength $minDesc }}
	{{- else if gt $descriptionLength $maxDesc }}
		{{- $lengthMessage = printf "Description too long on page '%s'. %d characters is > %d" .Page.TranslationKey $descriptionLength $maxDesc }}
	{{- end }}
	{{- if ne $lengthMessage "" }}
		{{- if eq $errorLevel "warning" }}
			{{- warnf $lengthMessage }}
		{{- else if eq $errorLevel "error" }}
			{{- errorf $lengthMessage }}
		{{- end }}
	{{- end }}
{{- end }}
<meta name="description" content="{{ $description }}">
